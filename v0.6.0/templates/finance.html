<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>КондCRM - Финансы</title>
    <!-- Подключаем Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Подключаем Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Подключаем наш файл со стилями -->
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Стили для анимации загрузки */
        .loader {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Стили для уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-medium: font-medium;
            opacity: 0;
            transform: translateY(-100%);
            transition: all 0.3s ease-in-out;
            z-index: 1000;
        }

        .notification-show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification-success {
            background-color: #10b981;
        }

        .notification-error {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Боковое меню -->
        <div class="w-64 bg-white border-r flex flex-col">
            <div class="p-6">
                <h1 class="text-2xl font-bold">КондCRM</h1>
            </div>
            
            <nav class="mt-6 flex-1">
                <a href="/" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="dashboard">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Дашборд
                </a>
                <a href="/orders" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="orders">
                    <i class="fas fa-shopping-bag mr-3"></i>
                    Заказы
                </a>
                <a href="/clients" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="clients">
                    <i class="fas fa-users mr-3"></i>
                    Клиенты
                </a>
                <a href="/services" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="services">
                    <i class="fas fa-briefcase mr-3"></i>
                    Услуги
                </a>
                <a href="/employees" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="employees">
                    <i class="fas fa-user-check mr-3"></i>
                    Сотрудники
                </a>
                <a href="/salary" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="salary">
                    <i class="fas fa-money-bill-wave mr-3"></i>
                    Зарплаты
                </a>
                <a href="/finance" class="menu-item active flex items-center px-6 py-3 text-sm" data-page="finance">
                    <i class="fas fa-chart-line mr-3"></i>
                    Финансы
                </a>
                <a href="/export" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="export">
                    <i class="fas fa-download mr-3"></i>
                    Экспорт данных
                </a>
                <a href="#" class="menu-item flex items-center px-6 py-3 text-sm text-gray-700" data-page="settings">
                    <i class="fas fa-cog mr-3"></i>
                    Настройки
                </a>
            </nav>
            
            <div class="mx-6 mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold">Обновите до PRO</h3>
                <p class="text-sm text-gray-600 mt-2">Получите доступ к дополнительным функциям и аналитике</p>
                <button class="mt-4 bg-blue-600 text-white w-full py-2 rounded font-medium hover:bg-blue-700 transition">
                    Обновить
                </button>
            </div>
        </div>
        
        <!-- Основной контент -->
        <div class="flex-1 overflow-auto">
            <!-- Верхняя панель -->
            <header class="bg-white p-6 flex items-center justify-between border-b sticky top-0 z-10">
                <h1 class="text-2xl font-bold">Финансовый учет</h1>
                
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input
                            type="text"
                            placeholder="Поиск транзакций..."
                            class="pl-10 pr-4 py-2 border rounded-full w-64 focus:outline-none focus:ring-2 focus:ring-blue-400"
                            id="search-input"
                        />
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    
                    <button class="relative p-2 text-gray-500 hover:bg-gray-100 rounded-full" id="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">
                        А
                    </div>
                </div>
            </header>
            
            <!-- Фильтры и период -->
            <div class="p-6 pb-0 flex justify-between items-center">
                <div class="bg-white rounded-full shadow-sm inline-flex">
                    <button class="px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-100 rounded-l-full period-btn" data-period="day">День</button>
                    <button class="px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-100 period-btn" data-period="week">Неделя</button>
                    <button class="px-4 py-2 text-sm font-medium bg-gray-700 text-white period-btn" data-period="month">Месяц</button>
                    <button class="px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-100 rounded-r-full period-btn" data-period="year">Год</button>
                </div>
                
                <div class="flex items-center space-x-2 bg-white rounded-full px-4 py-2 border">
                    <i class="fas fa-calendar text-gray-500"></i>
                    <span id="date-range">Загрузка...</span>
                </div>
            </div>
            
            <!-- Текущий баланс компании -->
            <div class="p-6">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <div>
                            <h3 class="text-lg font-semibold">Текущий баланс компании</h3>
                            <p class="text-gray-500 text-sm">Последнее обновление: <span id="last-update-date">Загрузка...</span></p>
                        </div>
                        <div class="mt-4 md:mt-0 flex items-center space-x-2">
                            <!-- Показывать кнопку установки баланса только если баланс не установлен -->
                            <button id="set-initial-balance-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
                                <i class="fas fa-piggy-bank mr-1"></i> Установить начальный баланс
                            </button>
                            <button id="add-expense-btn" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium px-4 py-2 rounded mr-2">
                                <i class="fas fa-minus mr-1"></i> Расход
                            </button>
                            <button id="add-income-btn" class="bg-green-100 hover:bg-green-200 text-green-700 font-medium px-4 py-2 rounded">
                                <i class="fas fa-plus mr-1"></i> Доход
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
                        <div class="flex-1 border rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <h4 class="text-gray-500">Текущий баланс</h4>
                                <span class="text-gray-500"><i class="fas fa-wallet"></i></span>
                            </div>
                            <p class="text-3xl font-bold mt-2" id="current-balance">Загрузка...</p>
                            <div class="flex items-center mt-2 text-sm" id="balance-change">
                                <span class="text-gray-500">Загрузка...</span>
                            </div>
                        </div>
                        
                        <div class="flex-1 border rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <h4 class="text-gray-500">Доходы за период</h4>
                                <span class="text-green-500"><i class="fas fa-arrow-up"></i></span>
                            </div>
                            <p class="text-3xl font-bold mt-2 text-green-600" id="period-income">Загрузка...</p>
                            <div class="flex items-center mt-2 text-sm" id="income-change">
                                <span class="text-gray-500">Загрузка...</span>
                            </div>
                        </div>
                        
                        <div class="flex-1 border rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <h4 class="text-gray-500">Расходы за период</h4>
                                <span class="text-red-500"><i class="fas fa-arrow-down"></i></span>
                            </div>
                            <p class="text-3xl font-bold mt-2 text-red-600" id="period-expenses">Загрузка...</p>
                            <div class="flex items-center mt-2 text-sm" id="expenses-change">
                                <span class="text-gray-500">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Графики и диаграммы -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                <!-- График доходов и расходов -->
                <div class="col-span-1 lg:col-span-2 bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-lg">Доходы и расходы</h2>
                        <div class="flex items-center space-x-2">
                            <span id="chart-loading" class="hidden flex items-center">
                                <div class="loader"></div>
                                <span>Загрузка...</span>
                            </span>
                            <button class="text-gray-500 hover:text-gray-700 ml-2">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="h-64 border-b pb-2 relative" id="finance-chart">
                        <canvas id="finance-chart-canvas"></canvas>
                    </div>
                    
                    <div class="flex justify-center mt-4 space-x-6">
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 bg-green-500 rounded mr-2"></span>
                            <span class="text-sm text-gray-600">Доходы</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 bg-red-500 rounded mr-2"></span>
                            <span class="text-sm text-gray-600">Расходы</span>
                        </div>
                    </div>
                </div>
                
                <!-- Структура расходов -->
                <div class="col-span-1 bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="font-bold text-lg mb-6">Структура расходов</h2>
                    
                    <div class="relative h-52 w-52 mx-auto mb-4">
                        <canvas id="expenses-chart-canvas"></canvas>
                    </div>
                    
                    <div class="space-y-2" id="expenses-legend">
                        <!-- Легенда будет динамически добавлена через JavaScript -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="inline-block w-3 h-3 rounded-full bg-gray-300 mr-2"></span>
                                <span class="text-sm text-gray-500">Загрузка...</span>
                            </div>
                            <span class="text-sm font-medium text-gray-500">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Прогноз на будущие периоды -->
            <div class="p-6">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="font-bold text-lg mb-4">Прогноз денежных потоков на ближайшие 3 месяца</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 text-gray-600 text-sm">
                                <tr>
                                    <th class="py-3 px-4 text-left font-medium">Месяц</th>
                                    <th class="py-3 px-4 text-left font-medium">Ожидаемые доходы</th>
                                    <th class="py-3 px-4 text-left font-medium">Ожидаемые расходы</th>
                                    <th class="py-3 px-4 text-left font-medium">Прогнозируемая прибыль</th>
                                    <th class="py-3 px-4 text-left font-medium">Ожидаемый баланс</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y" id="forecast-table-body">
                                <tr>
                                    <td colspan="5" class="py-3 px-4 text-center text-gray-500">
                                        <div class="loader inline-block"></div>
                                        Загрузка данных...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- История транзакций -->
            <div class="p-6">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-6 flex justify-between items-center border-b">
                        <h2 class="font-bold text-lg">История транзакций</h2>
                        <div class="flex space-x-2">
                            <div>
                                <select id="transaction-type-filter" class="border rounded p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                                    <option value="all">Все типы</option>
                                    <option value="income">Только доходы</option>
                                    <option value="expense">Только расходы</option>
                                </select>
                            </div>
                            <button class="p-2 text-gray-500 hover:bg-gray-100 rounded" id="refresh-transactions">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="p-2 text-gray-500 hover:bg-gray-100 rounded">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="transactions-loading" class="loading hidden p-6 text-center text-gray-500">
                        <div class="loader inline-block"></div>
                        <span>Загрузка транзакций...</span>
                    </div>
                    
                    <div class="overflow-x-auto" id="transactions-table-container">
                        <table class="w-full">
                            <thead class="bg-gray-50 text-gray-600 text-sm">
                                <tr>
                                    <th class="text-left py-4 px-6 font-medium">Дата</th>
                                    <th class="text-left py-4 px-6 font-medium">Описание</th>
                                    <th class="text-left py-4 px-6 font-medium">Тип</th>
                                    <th class="text-left py-4 px-6 font-medium">Категория</th>
                                    <th class="text-left py-4 px-6 font-medium">Сумма</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y" id="transactions-table-body">
                                <tr>
                                    <td colspan="5" class="py-4 px-6 text-center text-gray-500">
                                        <div class="loader inline-block"></div>
                                        Загрузка транзакций...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-4 border-t flex items-center justify-between">
                        <div class="text-sm text-gray-600" id="transactions-pagination-info">
                            Показано 0 из 0 транзакций
                        </div>
                        <div class="flex space-x-2" id="pagination-controls">
                            <button class="px-3 py-1 border rounded hover:bg-gray-100 text-gray-600" id="prev-page">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="px-3 py-1 border rounded bg-blue-600 text-white">1</button>
                            <button class="px-3 py-1 border rounded hover:bg-gray-100 text-gray-600" id="next-page">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно установки начального баланса -->
    <div id="set-initial-balance-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold">Установить начальный баланс</h2>
                <p class="text-sm text-gray-600 mt-1">Эта операция может быть выполнена только один раз</p>
            </div>
            
            <div class="p-6">
                <form id="initial-balance-form">
                    <div class="mb-4">
                        <label for="initial-balance-amount" class="block text-sm font-medium text-gray-700 mb-2">Начальный баланс</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₽</span>
                            <input 
                                type="number" 
                                id="initial-balance-amount" 
                                class="pl-8 p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                                placeholder="0.00"
                                min="0"
                                step="0.01"
                                required
                            >
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="initial-balance-description" class="block text-sm font-medium text-gray-700 mb-2">Описание (опционально)</label>
                        <textarea 
                            id="initial-balance-description" 
                            class="p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                            rows="2"
                            placeholder="Добавьте комментарий к начальному балансу"
                        ></textarea>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-yellow-800 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                            </div>
                            <div>
                                <p>Внимание! Начальный баланс можно установить только один раз и его нельзя будет изменить позже.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button id="cancel-initial-balance-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-4 py-2 rounded">
                    Отмена
                </button>
                <button id="confirm-initial-balance-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
                    Установить баланс
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно добавления расхода -->
    <div id="add-expense-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold">Добавить расход</h2>
            </div>
            
            <div class="p-6">
                <form id="expense-form">
                    <div class="mb-4">
                        <label for="expense-category" class="block text-sm font-medium text-gray-700 mb-2">Категория расхода</label>
                        <select id="expense-category" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="Закупка кондиционеров">Закупка кондиционеров</option>
                            <option value="Зарплаты">Зарплаты</option>
                            <option value="Расходные материалы">Расходные материалы</option>
                            <option value="Транспорт">Транспорт</option>
                            <option value="Аренда">Аренда</option>
                            <option value="Маркетинг">Маркетинг</option>
                            <option value="Прочие расходы">Прочие расходы</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-2">Сумма</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₽</span>
                            <input 
                                type="number" 
                                id="expense-amount" 
                                class="pl-8 p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                                placeholder="0.00"
                                required
                            >
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="expense-date" class="block text-sm font-medium text-gray-700 mb-2">Дата расхода</label>
                        <input 
                            type="date" 
                            id="expense-date" 
                            class="p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                            required
                        >
                    </div>
                    
                    <div class="mb-4">
                        <label for="expense-description" class="block text-sm font-medium text-gray-700 mb-2">Описание</label>
                        <textarea 
                            id="expense-description" 
                            class="p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                            rows="3"
                            placeholder="Укажите детали расхода"
                        ></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="expense-type" class="block text-sm font-medium text-gray-700 mb-2">Тип расхода</label>
                        <select id="expense-type" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="операционный">Операционный</option>
                            <option value="закупка товара">Закупка товара</option>
                            <option value="налоговый">Налоговый</option>
                            <option value="другое">Прочее</option>
                        </select>
                    </div>
                </form>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button id="cancel-expense-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-4 py-2 rounded">
                    Отмена
                </button>
                <button id="confirm-expense-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded">
                    Добавить расход
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно добавления дохода -->
    <div id="add-income-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold">Добавить доход</h2>
            </div>
            
            <div class="p-6">
                <form id="income-form">
                    <div class="mb-4">
                        <label for="income-source" class="block text-sm font-medium text-gray-700 mb-2">Источник дохода</label>
                        <select id="income-source" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="заказ">Заказ</option>
                            <option value="возврат средств">Возврат средств</option>
                            <option value="вклад владельца">Вклад владельца</option>
                            <option value="Другое">Прочее</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="income-amount" class="block text-sm font-medium text-gray-700 mb-2">Сумма</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₽</span>
                            <input 
                                type="number" 
                                id="income-amount" 
                                class="pl-8 p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                                placeholder="0.00"
                                required
                            >
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="income-date" class="block text-sm font-medium text-gray-700 mb-2">Дата дохода</label>
                        <input 
                            type="date" 
                            id="income-date" 
                            class="p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                            required
                        >
                    </div>
                    
                    <div class="mb-4">
                        <label for="income-description" class="block text-sm font-medium text-gray-700 mb-2">Описание</label>
                        <textarea 
                            id="income-description" 
                            class="p-3 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-400" 
                            rows="3"
                            placeholder="Укажите детали дохода"
                        ></textarea>
                    </div>
                </form>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button id="cancel-income-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-4 py-2 rounded">
                    Отмена
                </button>
                <button id="confirm-income-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded">
                    Добавить доход
                </button>
            </div>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div id="notification" class="notification">
        <span id="notification-message"></span>
    </div>

    <!-- Подключаем Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Подключаем JavaScript -->
    <script>
        // API клиент для работы с реальным API
        const api = {
            baseUrl: window.location.hostname === 'localhost' ? 'http://localhost:8000/api' : '/api',
            
            async get(endpoint, params = {}) {
                try {
                    const url = new URL(`${this.baseUrl}/${endpoint}`);
                    Object.keys(params).forEach(key => {
                        if (params[key] !== '' && params[key] !== null && params[key] !== undefined) {
                            url.searchParams.append(key, params[key]);
                        }
                    });
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `HTTP error: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`API Error (GET ${endpoint}):`, error);
                    throw error;
                }
            },
            
            async post(endpoint, data) {
                try {
                    const response = await fetch(`${this.baseUrl}/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `HTTP error: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`API Error (POST ${endpoint}):`, error);
                    throw error;
                }
            },
            
            // Получение финансовой сводки
            async getFinanceSummary(dateFrom, dateTo) {
                return this.get('finance/summary', { date_from: dateFrom, date_to: dateTo });
            },
            
            // Получение прогноза денежных потоков
            async getCashFlowForecast(monthsAhead = 3) {
                return this.get('finance/forecast', { months_ahead: monthsAhead });
            },
            
            // Получение истории транзакций
            async getTransactions(params = {}) {
                return this.get('finance/transactions', params);
            },
            
            // Получение текущего баланса
            async getBalance() {
                return this.get('finance/balance');
            },
            
            // Добавление расхода
            async addExpense(expenseData) {
                return this.post('finance/expenses', expenseData);
            },
            
            // Установка начального баланса
            async setInitialBalance(initialBalance) {
                return this.post('finance/initial-balance', { initial_balance: initialBalance });
            }
        };

        // Форматирование данных
        const formatter = {
            currency(value) {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: 'RUB',
                    maximumFractionDigits: 0
                }).format(value);
            },
            
            date(dateString) {
                return new Date(dateString).toLocaleDateString('ru-RU');
            },
            
            datetime(dateString) {
                return new Date(dateString).toLocaleString('ru-RU');
            }
        };

        // Компонент страницы финансов
        const financePage = {
            currentPeriod: 'month',
            currentPage: 1,
            totalPages: 1,
            financeChart: null,
            expensesChart: null,
            
            init() {
                this.setupEventListeners();
                this.loadFinanceData();
            },
            
            setupEventListeners() {
                // Обработчики переключения периода
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const activeBtn = document.querySelector('.period-btn.bg-gray-700');
                        if (activeBtn) {
                            activeBtn.classList.remove('bg-gray-700', 'text-white');
                            activeBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                        }
                        
                        btn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                        btn.classList.add('bg-gray-700', 'text-white');
                        
                        this.currentPeriod = btn.dataset.period;
                        this.loadFinanceData();
                    });
                });
                
                // Обновить транзакции
                const refreshBtn = document.getElementById('refresh-transactions');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.loadTransactions();
                    });
                }
                
                // Фильтр типа транзакции
                const typeFilter = document.getElementById('transaction-type-filter');
                if (typeFilter) {
                    typeFilter.addEventListener('change', (e) => {
                        this.currentPage = 1;
                        this.loadTransactions(e.target.value);
                    });
                }
                
                // Поиск транзакций
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    let timeout = null;
                    searchInput.addEventListener('input', (e) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            this.currentPage = 1;
                            this.loadTransactions('all', e.target.value);
                        }, 500);
                    });
                }
                
                // Пагинация транзакций
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (this.currentPage > 1) {
                            this.currentPage--;
                            this.loadTransactions();
                        }
                    });
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (this.currentPage < this.totalPages) {
                            this.currentPage++;
                            this.loadTransactions();
                        }
                    });
                }
                
                // Модальные окна - Начальный баланс
                const setInitialBalanceBtn = document.getElementById('set-initial-balance-btn');
                const cancelInitialBalanceBtn = document.getElementById('cancel-initial-balance-btn');
                const confirmInitialBalanceBtn = document.getElementById('confirm-initial-balance-btn');
                
                if (setInitialBalanceBtn) {
                    setInitialBalanceBtn.addEventListener('click', () => this.openInitialBalanceModal());
                }
                
                if (cancelInitialBalanceBtn) {
                    cancelInitialBalanceBtn.addEventListener('click', () => this.closeInitialBalanceModal());
                }
                
                if (confirmInitialBalanceBtn) {
                    confirmInitialBalanceBtn.addEventListener('click', () => this.setInitialBalance());
                }
                
                // Модальные окна - Расход
                const addExpenseBtn = document.getElementById('add-expense-btn');
                const cancelExpenseBtn = document.getElementById('cancel-expense-btn');
                const confirmExpenseBtn = document.getElementById('confirm-expense-btn');
                
                if (addExpenseBtn) {
                    addExpenseBtn.addEventListener('click', () => this.openExpenseModal());
                }
                
                if (cancelExpenseBtn) {
                    cancelExpenseBtn.addEventListener('click', () => this.closeExpenseModal());
                }
                
                if (confirmExpenseBtn) {
                    confirmExpenseBtn.addEventListener('click', () => this.addExpense());
                }
                
                // Модальные окна - Доход
                const addIncomeBtn = document.getElementById('add-income-btn');
                const cancelIncomeBtn = document.getElementById('cancel-income-btn');
                const confirmIncomeBtn = document.getElementById('confirm-income-btn');
                
                if (addIncomeBtn) {
                    addIncomeBtn.addEventListener('click', () => this.openIncomeModal());
                }
                
                if (cancelIncomeBtn) {
                    cancelIncomeBtn.addEventListener('click', () => this.closeIncomeModal());
                }
                
                if (confirmIncomeBtn) {
                    confirmIncomeBtn.addEventListener('click', () => this.addIncome());
                }
                
                // Обработка Enter в формах
                ['initial-balance-form', 'expense-form', 'income-form'].forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form) {
                        form.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                switch(formId) {
                                    case 'initial-balance-form':
                                        this.setInitialBalance();
                                        break;
                                    case 'expense-form':
                                        this.addExpense();
                                        break;
                                    case 'income-form':
                                        this.addIncome();
                                        break;
                                }
                            }
                        });
                    }
                });
            },
            
            async loadFinanceData() {
                try {
                    const { dateFrom, dateTo, displayText } = this.getDateRange(this.currentPeriod);
                    const dateRangeElement = document.getElementById('date-range');
                    if (dateRangeElement) {
                        dateRangeElement.textContent = displayText;
                    }
                    
                    // Показываем индикатор загрузки для графика
                    const chartLoading = document.getElementById('chart-loading');
                    if (chartLoading) {
                        chartLoading.classList.remove('hidden');
                    }
                    
                    // Загружаем финансовую сводку
                    const summary = await api.getFinanceSummary(dateFrom, dateTo);
                    
                    // Обновляем показатели на странице
                    this.updateFinancialSummary(summary);
                    
                    // Загружаем прогноз денежных потоков
                    const forecast = await api.getCashFlowForecast(3);
                    
                    // Обновляем таблицу прогноза
                    this.updateForecastTable(forecast);
                    
                    // Загружаем текущий баланс
                    const balance = await api.getBalance();
                    
                    // Обновляем информацию о балансе
                    const balanceElement = document.getElementById('current-balance');
                    const lastUpdateElement = document.getElementById('last-update-date');
                    const setInitialBalanceBtn = document.getElementById('set-initial-balance-btn');
                    
                    if (balanceElement) {
                        if (balance.balance !== null) {
                            balanceElement.textContent = formatter.currency(balance.balance);
                        } else {
                            balanceElement.textContent = 'Не установлен';
                            balanceElement.classList.add('text-gray-400');
                        }
                    }
                    
                    if (lastUpdateElement) {
                        if (balance.updated_at) {
                            lastUpdateElement.textContent = formatter.datetime(balance.updated_at);
                        } else {
                            lastUpdateElement.textContent = 'Не установлен';
                        }
                    }
                    
                    // Показываем/скрываем кнопку установки начального баланса
                    if (setInitialBalanceBtn) {
                        if (!balance.initial_balance_set) {
                            setInitialBalanceBtn.classList.remove('hidden');
                        } else {
                            setInitialBalanceBtn.classList.add('hidden');
                        }
                    }
                    
                    // Обновляем графики
                    this.updateFinanceChart(summary);
                    if (summary.expenses_by_category) {
                        this.updateExpensesChart(summary.expenses_by_category);
                    }
                    
                    // Загружаем историю транзакций
                    this.loadTransactions();
                    
                    // Скрываем индикатор загрузки для графика
                    if (chartLoading) {
                        chartLoading.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке финансовых данных:', error);
                    this.showNotification('Ошибка при загрузке финансовых данных: ' + error.message, 'error');
                    
                    const chartLoading = document.getElementById('chart-loading');
                    if (chartLoading) {
                        chartLoading.classList.add('hidden');
                    }
                }
            },
            
            getDateRange(period) {
                const now = new Date();
                let dateFrom, dateTo;
                
                switch(period) {
                    case 'day':
                        dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        dateTo = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                        break;
                    case 'week':
                        const day = now.getDay() || 7;
                        dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1);
                        dateTo = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (7 - day), 23, 59, 59);
                        break;
                    case 'month':
                        dateFrom = new Date(now.getFullYear(), now.getMonth(), 1);
                        dateTo = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                        break;
                    case 'year':
                        dateFrom = new Date(now.getFullYear(), 0, 1);
                        dateTo = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                        break;
                    default:
                        dateFrom = new Date(now.getFullYear(), now.getMonth(), 1);
                        dateTo = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                        break;
                }
                
                return {
                    dateFrom: this.formatForAPI(dateFrom),
                    dateTo: this.formatForAPI(dateTo),
                    displayText: this.formatDateRangeForDisplay(dateFrom, dateTo)
                };
            },
            
            formatForAPI(date) {
                return date.toISOString().split('T')[0];
            },
            
            formatDateRangeForDisplay(dateFrom, dateTo) {
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                return `${dateFrom.toLocaleDateString('ru-RU', options)} - ${dateTo.toLocaleDateString('ru-RU', options)}`;
            },
            
            updateFinancialSummary(summary) {
                const incomeElement = document.getElementById('period-income');
                const expensesElement = document.getElementById('period-expenses');
                const balanceChangeElement = document.getElementById('balance-change');
                const incomeChangeElement = document.getElementById('income-change');
                const expensesChangeElement = document.getElementById('expenses-change');
                
                if (incomeElement) {
                    incomeElement.textContent = formatter.currency(summary.total_revenue || 0);
                }
                
                if (expensesElement) {
                    expensesElement.textContent = formatter.currency(summary.total_expenses || 0);
                }
                
                // Рассчитываем и показываем изменения (можно добавить логику сравнения с предыдущим периодом)
                const profitForPeriod = (summary.total_revenue || 0) - (summary.total_expenses || 0);
                
                if (balanceChangeElement) {
                    if (profitForPeriod >= 0) {
                        balanceChangeElement.innerHTML = `
                            <i class="fas fa-arrow-up mr-1 text-green-500"></i>
                            <span class="text-green-500">+${formatter.currency(profitForPeriod)} за период</span>
                        `;
                    } else {
                        balanceChangeElement.innerHTML = `
                            <i class="fas fa-arrow-down mr-1 text-red-500"></i>
                            <span class="text-red-500">${formatter.currency(profitForPeriod)} за период</span>
                        `;
                    }
                }
            },
            
            updateForecastTable(forecast) {
                const tbody = document.getElementById('forecast-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (!forecast || !forecast.forecast || !Array.isArray(forecast.forecast)) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="py-3 px-4 text-center text-gray-500">
                                Нет данных для прогноза
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const monthNames = [
                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                ];
                
                forecast.forecast.forEach(month => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    try {
                        const [year, monthNum] = month.month.split('-');
                        const monthIndex = parseInt(monthNum) - 1;
                        const monthName = monthNames[monthIndex] ? `${monthNames[monthIndex]} ${year}` : month.month;
                        
                        const profitClass = (month.forecasted_profit || 0) >= 0 ? 'text-green-600' : 'text-red-600';
                        
                        row.innerHTML = `
                            <td class="py-3 px-4">${monthName}</td>
                            <td class="py-3 px-4 text-green-600 font-medium">${formatter.currency(month.forecasted_revenue || 0)}</td>
                            <td class="py-3 px-4 text-red-600 font-medium">${formatter.currency(month.forecasted_expenses || 0)}</td>
                            <td class="py-3 px-4 font-medium ${profitClass}">${formatter.currency(month.forecasted_profit || 0)}</td>
                            <td class="py-3 px-4 font-medium">${formatter.currency(month.forecasted_balance || 0)}</td>
                        `;
                        
                        tbody.appendChild(row);
                    } catch (error) {
                        console.error('Ошибка при обработке месяца:', month, error);
                    }
                });
            },
            
            async loadTransactions(transactionType = 'all', searchQuery = '') {
                try {
                    // Показываем индикатор загрузки
                    const loadingElement = document.getElementById('transactions-loading');
                    const tableContainer = document.getElementById('transactions-table-container');
                    
                    if (loadingElement) loadingElement.classList.remove('hidden');
                    if (tableContainer) tableContainer.classList.add('hidden');
                    
                    // Получаем параметры текущего периода
                    const { dateFrom, dateTo } = this.getDateRange(this.currentPeriod);
                    
                    // Формируем параметры запроса
                    const params = {
                        date_from: dateFrom,
                        date_to: dateTo,
                        page: this.currentPage,
                        limit: 10
                    };
                    
                    // Добавляем тип транзакции
                    if (transactionType === 'income') {
                        params.transaction_type = 'доход';
                    } else if (transactionType === 'expense') {
                        params.transaction_type = 'расход';
                    }
                    
                    // Загружаем данные
                    const transactionsData = await api.getTransactions(params);
                    const transactions = transactionsData.transactions || [];
                    const totalCount = transactionsData.total_count || 0;
                    this.totalPages = Math.ceil(totalCount / 10);
                    
                    // Обновляем таблицу
                    this.updateTransactionsTable(transactions, totalCount);
                    
                    // Скрываем индикатор загрузки
                    if (loadingElement) loadingElement.classList.add('hidden');
                    if (tableContainer) tableContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('Ошибка при загрузке истории транзакций:', error);
                    this.showNotification('Ошибка при загрузке истории транзакций: ' + error.message, 'error');
                    
                    const loadingElement = document.getElementById('transactions-loading');
                    const tableContainer = document.getElementById('transactions-table-container');
                    
                    if (loadingElement) loadingElement.classList.add('hidden');
                    if (tableContainer) tableContainer.classList.remove('hidden');
                    
                    this.updateTransactionsTable([], 0);
                }
            },
            
            updateTransactionsTable(transactions, totalCount) {
                const tbody = document.getElementById('transactions-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (transactions.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" class="py-4 px-6 text-center text-gray-500">
                            Нет транзакций за выбранный период
                        </td>
                    `;
                    tbody.appendChild(row);
                } else {
                    transactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        const isIncome = transaction.transaction_type === 'доход';
                        const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
                        const amountPrefix = isIncome ? '+ ' : '- ';
                        const statusClass = isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        
                        row.innerHTML = `
                            <td class="py-4 px-6 text-sm">${formatter.date(transaction.transaction_date)}</td>
                            <td class="py-4 px-6 text-sm">${transaction.description || '-'}</td>
                            <td class="py-4 px-6">
                                <span class="${statusClass} text-xs font-medium px-2.5 py-0.5 rounded">
                                    ${isIncome ? 'Доход' : 'Расход'}
                                </span>
                            </td>
                            <td class="py-4 px-6 text-sm">${transaction.source_type}</td>
                            <td class="py-4 px-6 text-sm font-medium ${amountClass}">${amountPrefix}${formatter.currency(transaction.amount)}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                // Обновляем информацию о пагинации
                const paginationInfo = document.getElementById('transactions-pagination-info');
                if (paginationInfo) {
                    const startItem = (this.currentPage - 1) * 10 + 1;
                    const endItem = Math.min(this.currentPage * 10, totalCount);
                    paginationInfo.textContent = `Показано ${startItem}-${endItem} из ${totalCount} транзакций`;
                }
                
                // Обновляем кнопки пагинации
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                
                if (prevBtn) prevBtn.disabled = this.currentPage <= 1;
                if (nextBtn) nextBtn.disabled = this.currentPage >= this.totalPages;
            },
            
            updateFinanceChart(summary) {
                const ctx = document.getElementById('finance-chart-canvas');
                if (!ctx) return;
                
                // Уничтожаем предыдущий график, если он существует
                if (this.financeChart) {
                    this.financeChart.destroy();
                }
                
                // Получаем данные для графика
                const revenueByDate = summary.revenue_by_date || {};
                const expensesByDate = summary.expenses_by_date || {};
                
                // Создаем массив дат
                const dates = [...new Set([
                    ...Object.keys(revenueByDate),
                    ...Object.keys(expensesByDate)
                ])].sort();
                
                // Создаем данные для графика
                const data = {
                    labels: dates.map(date => {
                        try {
                            return new Date(date).getDate();
                        } catch {
                            return date;
                        }
                    }),
                    datasets: [
                        {
                            label: 'Доходы',
                            data: dates.map(date => Number(revenueByDate[date]) || 0),
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'Расходы',
                            data: dates.map(date => Number(expensesByDate[date]) || 0),
                            borderColor: '#ef4444',
                            backgroundColor: '#ef4444',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                };
                
                // Создаем график
                this.financeChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatter.currency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            updateExpensesChart(expensesByCategory) {
                const ctx = document.getElementById('expenses-chart-canvas');
                if (!ctx) return;
                
                // Уничтожаем предыдущий график, если он существует
                if (this.expensesChart) {
                    this.expensesChart.destroy();
                }
                
                // Подготавливаем данные
                const categories = Object.keys(expensesByCategory);
                const values = Object.values(expensesByCategory).map(v => Number(v) || 0);
                const total = values.reduce((sum, val) => sum + val, 0);
                
                if (total === 0 || categories.length === 0) {
                    // Если нет данных, показываем пустую диаграмму
                    this.updateExpensesLegend([]);
                    return;
                }
                
                // Создаем график
                this.expensesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // Обновляем легенду
                this.updateExpensesLegend(categories.map((category, index) => ({
                    category,
                    value: values[index],
                    percent: ((values[index] / total) * 100).toFixed(0),
                    color: ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6'][index % 7]
                })));
            },
            
            updateExpensesLegend(data) {
                const legend = document.getElementById('expenses-legend');
                if (!legend) return;
                
                legend.innerHTML = '';
                
                if (data.length === 0) {
                    legend.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="inline-block w-3 h-3 rounded-full bg-gray-300 mr-2"></span>
                                <span class="text-sm text-gray-500">Нет данных</span>
                            </div>
                            <span class="text-sm font-medium text-gray-500">0%</span>
                        </div>
                    `;
                    return;
                }
                
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${item.color}"></span>
                            <span class="text-sm">${item.category}</span>
                        </div>
                        <span class="text-sm font-medium">${item.percent}%</span>
                    `;
                    legend.appendChild(div);
                });
            },
            
            // Модальные окна - Начальный баланс
            openInitialBalanceModal() {
                const modal = document.getElementById('set-initial-balance-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    const amountInput = document.getElementById('initial-balance-amount');
                    if (amountInput) amountInput.focus();
                }
            },
            
            closeInitialBalanceModal() {
                const modal = document.getElementById('set-initial-balance-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    const form = document.getElementById('initial-balance-form');
                    if (form) form.reset();
                }
            },
            
            async setInitialBalance() {
                try {
                    const amount = parseFloat(document.getElementById('initial-balance-amount').value);
                    const description = document.getElementById('initial-balance-description').value;
                    
                    if (isNaN(amount) || amount < 0) {
                        this.showNotification('Введите корректную сумму начального баланса', 'error');
                        return;
                    }
                    
                    const confirmBtn = document.getElementById('confirm-initial-balance-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Обработка...';
                    }
                    
                    const result = await api.setInitialBalance(amount);
                    
                    if (result.success) {
                        this.showNotification('Начальный баланс успешно установлен', 'success');
                        this.closeInitialBalanceModal();
                        this.loadFinanceData();
                    } else {
                        this.showNotification('Ошибка при установке начального баланса: ' + (result.error || 'Неизвестная ошибка'), 'error');
                    }
                    
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Установить баланс';
                    }
                } catch (error) {
                    console.error('Ошибка при установке начального баланса:', error);
                    this.showNotification('Ошибка при установке начального баланса: ' + error.message, 'error');
                    
                    const confirmBtn = document.getElementById('confirm-initial-balance-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Установить баланс';
                    }
                }
            },
            
            // Модальные окна - Расход
            openExpenseModal() {
                const modal = document.getElementById('add-expense-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    const today = new Date().toISOString().split('T')[0];
                    const dateInput = document.getElementById('expense-date');
                    if (dateInput) dateInput.value = today;
                }
            },
            
            closeExpenseModal() {
                const modal = document.getElementById('add-expense-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    const form = document.getElementById('expense-form');
                    if (form) form.reset();
                }
            },
            
            async addExpense() {
                try {
                    const category = document.getElementById('expense-category').value;
                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const expenseDate = document.getElementById('expense-date').value;
                    const description = document.getElementById('expense-description').value;
                    const expenseType = document.getElementById('expense-type').value;
                    
                    if (!category || isNaN(amount) || amount <= 0 || !expenseDate) {
                        this.showNotification('Заполните все обязательные поля корректно', 'error');
                        return;
                    }
                    
                    const confirmBtn = document.getElementById('confirm-expense-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Обработка...';
                    }
                    
                    const expenseData = {
                        category: category,
                        amount: amount,
                        expense_date: expenseDate,
                        description: description,
                        expense_type: expenseType
                    };
                    
                    const result = await api.addExpense(expenseData);
                    
                    if (result.success) {
                        this.showNotification('Расход успешно добавлен', 'success');
                        this.closeExpenseModal();
                        this.loadFinanceData();
                    } else {
                        this.showNotification('Ошибка при добавлении расхода: ' + (result.error || 'Неизвестная ошибка'), 'error');
                    }
                    
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Добавить расход';
                    }
                } catch (error) {
                    console.error('Ошибка при добавлении расхода:', error);
                    this.showNotification('Ошибка при добавлении расхода: ' + error.message, 'error');
                    
                    const confirmBtn = document.getElementById('confirm-expense-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Добавить расход';
                    }
                }
            },
            
            // Модальные окна - Доход
            openIncomeModal() {
                const modal = document.getElementById('add-income-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    const today = new Date().toISOString().split('T')[0];
                    const dateInput = document.getElementById('income-date');
                    if (dateInput) dateInput.value = today;
                }
            },
            
            closeIncomeModal() {
                const modal = document.getElementById('add-income-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    const form = document.getElementById('income-form');
                    if (form) form.reset();
                }
            },
            
            async addIncome() {
                try {
                    const source = document.getElementById('income-source').value;
                    const amount = parseFloat(document.getElementById('income-amount').value);
                    const incomeDate = document.getElementById('income-date').value;
                    const description = document.getElementById('income-description').value;
                    
                    if (!source || isNaN(amount) || amount <= 0 || !incomeDate) {
                        this.showNotification('Заполните все обязательные поля корректно', 'error');
                        return;
                    }
                    
                    const confirmBtn = document.getElementById('confirm-income-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Обработка...';
                    }
                    
                    // Для дохода создаем транзакцию напрямую
                    const transactionData = {
                        transaction_date: incomeDate,
                        amount: amount,
                        transaction_type: 'доход',
                        source_type: source,
                        description: description || `Доход из источника: ${source}`
                    };
                    
                    // API для добавления дохода напрямую не предусмотрен, поэтому используем альтернативный способ
                    // В реальной реализации лучше добавить соответствующий API endpoint
                    this.showNotification('Функция добавления дохода временно недоступна', 'error');
                    
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Добавить доход';
                    }
                } catch (error) {
                    console.error('Ошибка при добавлении дохода:', error);
                    this.showNotification('Ошибка при добавлении дохода: ' + error.message, 'error');
                    
                    const confirmBtn = document.getElementById('confirm-income-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Добавить доход';
                    }
                }
            },
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const messageElement = document.getElementById('notification-message');
                
                if (!notification || !messageElement) return;
                
                messageElement.textContent = message;
                
                notification.className = 'notification';
                if (type === 'success') {
                    notification.classList.add('notification-success');
                } else if (type === 'error') {
                    notification.classList.add('notification-error');
                }
                notification.classList.add('notification-show');
                
                setTimeout(() => {
                    notification.classList.remove('notification-show');
                }, 3000);
            }
        };

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            financePage.init();
        });
    </script>
</body>
</html>
